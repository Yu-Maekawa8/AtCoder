name: Sync AtCoder Submissions

on:
  schedule:
    - cron: '0 22 * * *'       # æ¯Žæ—¥ æ—¥æœ¬æ™‚é–“ æœ7æ™‚ã«å®Ÿè¡Œï¼ˆé€²æ—æ›´æ–°ã®1æ™‚é–“å¾Œï¼‰
  workflow_dispatch:          # æ‰‹å‹•å®Ÿè¡Œã‚‚è¨±å¯
    inputs:
      days_back:
        description: 'ä½•æ—¥å‰ã¾ã§é¡ã£ã¦åŒæœŸã™ã‚‹ã‹'
        required: false
        default: '7'
        type: string
      full_history:
        description: 'å…¨å±¥æ­´åŒæœŸã‚’å®Ÿè¡Œã™ã‚‹ã‹ï¼ˆåˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  sync-submissions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml
          
      - name: Sync AtCoder submissions
        id: sync
        env:
          ATCODER_USER_ID: Y_maekawa
        run: |
          EXTRA_ARGS=""
          if [ "${{ github.event.inputs.full_history }}" == "true" ]; then
            EXTRA_ARGS="--all-history"
            echo "ðŸ”„ å…¨å±¥æ­´åŒæœŸãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
          else
            EXTRA_ARGS="--days-back ${{ github.event.inputs.days_back || '7' }}"
            echo "ðŸ“… éŽåŽ»${{ github.event.inputs.days_back || '7' }}æ—¥é–“ã®åŒæœŸ"
          fi
          
          python auto_sync_submissions.py $EXTRA_ARGS > sync_output.txt 2>&1
          
          # åŒæœŸçµæžœã‚’ç¢ºèª
          if grep -q "åŒæœŸå®Œäº†" sync_output.txt; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ã‚’å–å¾—
            NEW_FILES=$(git status --porcelain | grep "^??" | wc -l)
            MODIFIED_FILES=$(git status --porcelain | grep "^.M" | wc -l)
            echo "new_files=$NEW_FILES" >> $GITHUB_OUTPUT
            echo "modified_files=$MODIFIED_FILES" >> $GITHUB_OUTPUT
            
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
            if [ $NEW_FILES -gt 0 ] && [ $MODIFIED_FILES -gt 0 ]; then
              COMMIT_MSG="ðŸŽ‰ AtCoder ACåŒæœŸ: ${NEW_FILES}å€‹ã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«, ${MODIFIED_FILES}å€‹ã®æ›´æ–°"
            elif [ $NEW_FILES -gt 0 ]; then
              COMMIT_MSG="ðŸŽ‰ AtCoder ACåŒæœŸ: ${NEW_FILES}å€‹ã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«"
            else
              COMMIT_MSG="ðŸ“ AtCoderé€²æ—æ›´æ–°"
            fi
            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ­ã‚°ã‚’å‡ºåŠ›
          cat sync_output.txt
          
      - name: Update progress after sync
        if: steps.sync.outputs.has_changes == 'true'
        run: python update_readme.py
        
      - name: Commit and push changes
        if: steps.sync.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ã™ã¹ã¦ã®å¤‰æ›´ã‚’è¿½åŠ 
          git add .
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
          COMMIT_MSG="${{ steps.sync.outputs.commit_message }}"
          
          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if ! git diff --cached --quiet; then
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ: $COMMIT_MSG"
          else
            echo "ðŸ“ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸš€ AtCoderæå‡ºåŒæœŸçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.sync.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **åŒæœŸæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            echo "- æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.sync.outputs.new_files }}å€‹" >> $GITHUB_STEP_SUMMARY
            echo "- æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.sync.outputs.modified_files }}å€‹" >> $GITHUB_STEP_SUMMARY
            echo "- ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \`${{ steps.sync.outputs.commit_message }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **æ–°ã—ã„ACæå‡ºã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š å®Ÿè¡Œãƒ­ã‚°" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat sync_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
